# Zephyr-HOWTOs
Some HOWTOs in Zephyr RTOS that I would like to share 
## smp_svr
A minimally configured smp_svr sample that enables MCUBoot with secondary slot in external SPI NOR flash.

Tested on Windows 11 machine using VSCode, nRF Connect SDK v2.0.x and v2.1.0. Hardware is a custom Laird BL653u module, which, from Zephyr's point of view, is equivalent to nRF52833-QIAA. Thus, this project should work off-of-shelf with in-tree boards such as BL653_DVK, nRF52833dk_nRF52833, and nRF52840dk_nRF52840.

The SPI NOR chip is a Winbond W25Q128 connected to default &spi1 bus.

Pay special attention to:
- `/child_image` and `CMakeLists.txt` which specifies mcuboot_DTC_OVERLAY_FILE. The set statement must preceed find_package().
- `/child_image/mcuboot.conf` which configures MCUBoot partition size, boot strategy, and awareness of SPI NOR external flash space.
- `build/partitions.yml` which can be renamed as `pm_static.yml`, relocated to project root folder, and serve as the partition description for child images (i.e. MCUBoot). 
It is very important to understand that `partitions.yml` is dynamically generated by reading project devicetree and Kconfig, but the algorithm is not smart enough to closely follow these inputs. 
As a result, modifications must be done manually to ensure correct placement of partitions. The `pm_static.yml` configuration will not affect other subsystems (such as littlefs), 
so devicetree description is still very relevant to the project even though warnings or erros will not appear if they mismatch.
- `build/zephyr/.config` and `build/zephyr/zephyr.dts` are the final Kconfig and devicetree that goes into the compiler for the parent image. Review this if debugging is needed.
- `build/mcuboot/zephyr/.config` and `build/mcuboot/zephyr/zephyr.dts` are the final Kconfig and devicetree that goes into the compiler for the child image. Review this if debugging is needed.
- Using `.overlay` file in a parent-child build is not really a good practice, considering the alternative, i.e. providing a custom `/boards/<Arch>/<Boardname>` folder, can be compiled without additional `CMakeLists.txt` directives.
- It is very likely that your SPI NOR chip comforms to the same `jesd216` standard, so the devicetree specifications will likely be similar. If unsure about some of the inputs, i.e. `sfdp-bfp` or `jedec-id`, compile a 
[JESD216 Sample](https://docs.zephyrproject.org/2.6.0/samples/drivers/jesd216/README.html)
to retrieve needed information.
